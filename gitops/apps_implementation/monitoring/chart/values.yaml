# Global settings
global:
  namespace: monitoring

cert-manager:
  enabled: true
  installCRDs: true

opentelemetry-operator:
  enabled: true
  manager:
    autoInstrumentation:
      go:
        enabled: true
    autoInstrumentationImage:
      go:
        repository: ghcr.io/open-telemetry/opentelemetry-go-instrumentation/autoinstrumentation-go
        tag: v0.23.0

# OpenTelemetry Collector CRD (managed by operator)
opentelemetryCollector:
  enabled: true
  name: monitoring-collector
  image: otel/opentelemetry-collector-contrib:latest
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 256Mi
  exporters:
    tempoEndpoint: tempo.monitoring.svc.cluster.local:4317
    prometheusEndpoint: http://prometheus-server.monitoring.svc.cluster.local:80/api/v1/write

# Prometheus configuration
prometheus:
  enabled: true
  alertmanager:
    enabled: false
  
  prometheus-pushgateway:
    enabled: false
  
  kube-state-metrics:
    enabled: true
  
  prometheus-node-exporter:
    enabled: true
  
  server:
    resources:
      requests:
        cpu: 100m
        memory: 512Mi
      limits:
        cpu: 500m
        memory: 1Gi
    
    retention: "7d"
    
    extraArgs:
      web.enable-remote-write-receiver: ""
    
    service:
      type: ClusterIP
      servicePort: 80
    
    persistentVolume:
      enabled: false
    
    emptyDir:
      sizeLimit: ""
  
  # Prometheus 28: serverFiles is top-level (sibling of server)
  serverFiles:
    prometheus.yml:
      scrape_configs:
        - job_name: 'otel-collector'
          static_configs:
            - targets: ['collector-monitoring.monitoring.svc.cluster.local:8888']
        
        - job_name: 'backend'
          kubernetes_sd_configs:
            - role: pod
          relabel_configs:
            - source_labels: [__meta_kubernetes_pod_label_app]
              regex: diiage-finals-app.*backend
              action: keep
            - source_labels: [__meta_kubernetes_pod_ip]
              target_label: __address__
              action: replace
              regex: '(.+)'
              replacement: '$1:8080'
  
  persistence:
    enabled: false

# Tempo configuration
tempo:
  enabled: true
  replicas: 1
  
  tempo:
    repository: grafana/tempo
    tag: 2.3.1
    pullPolicy: IfNotPresent
    
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 1Gi
    
    storage:
      trace:
        backend: local
        local:
          path: /tmp/tempo/traces
        wal:
          path: /tmp/tempo/wal
    
    ingester:
      max_block_duration: 5m
    
    compactor:
      compaction:
        block_retention: 48h
    
    server:
      http_listen_port: 3200
    
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318
  
  persistence:
    enabled: false
  
  securityContext:
    runAsUser: 10001
    runAsGroup: 10001
    fsGroup: 10001
    runAsNonRoot: true

# Grafana configuration
grafana:
  enabled: true
  
  adminUser: admin
  adminPassword: admin
  
  service:
    type: ClusterIP
    port: 80
  
  persistence:
    enabled: true
    type: pvc
    accessModes:
      - ReadWriteOnce
    size: 10Gi
    annotations: {}
  
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi
  
  grafana.ini:
    server:
      root_url: "%(protocol)s://%(domain)s:%(http_port)s/"
    
    auth:
      disable_login_form: false
      anonymous:
        enabled: true
        org_role: Viewer
  
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
        - name: Prometheus
          type: prometheus
          access: proxy
          url: http://monitoring-prometheus-server.monitoring:80
          isDefault: true
          editable: true
          jsonData:
            timeInterval: 15s
        
        - name: Tempo
          type: tempo
          access: proxy
          url: http://tempo:3200
          isDefault: false
          editable: true
          jsonData:
            httpMethod: GET
            serviceMap:
              datasourceUid: Prometheus
            nodeGraph:
              enabled: true
        
        - name: Tempo (Search)
          type: tempo
          access: proxy
          url: http://tempo:3200
          isDefault: false
          editable: true
          jsonData:
            httpMethod: GET
            search:
              hide: false
            nodeGraph:
              enabled: true
            serviceMap:
              datasourceUid: Prometheus
  
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
        - name: 'default'
          orgId: 1
          folder: ''
          type: file
          disableDeletion: false
          editable: true
          options:
            path: /var/lib/grafana/dashboards/default
  
  dashboards:
    default:
      otel-collector:
        json: |
          {
            "title": "OpenTelemetry Collector",
            "tags": ["opentelemetry", "collector"],
            "timezone": "browser",
            "schemaVersion": 38,
            "version": 0,
            "refresh": "10s",
            "time": {
              "from": "now-1h",
              "to": "now"
            },
            "panels": [
              {
                "id": 1,
                "title": "Spans Received",
                "type": "timeseries",
                "gridPos": {"x": 0, "y": 0, "w": 12, "h": 8},
                "datasource": {"type": "prometheus", "uid": "Prometheus"},
                "targets": [
                  {
                    "expr": "rate(otelcol_receiver_accepted_spans[5m])",
                    "legendFormat": "{{receiver}}",
                    "refId": "A"
                  }
                ]
              },
              {
                "id": 2,
                "title": "Metrics Received",
                "type": "timeseries",
                "gridPos": {"x": 12, "y": 0, "w": 12, "h": 8},
                "datasource": {"type": "prometheus", "uid": "Prometheus"},
                "targets": [
                  {
                    "expr": "rate(otelcol_receiver_accepted_metric_points[5m])",
                    "legendFormat": "{{receiver}}",
                    "refId": "A"
                  }
                ]
              },
              {
                "id": 3,
                "title": "Spans Exported",
                "type": "timeseries",
                "gridPos": {"x": 0, "y": 8, "w": 12, "h": 8},
                "datasource": {"type": "prometheus", "uid": "Prometheus"},
                "targets": [
                  {
                    "expr": "rate(otelcol_exporter_sent_spans[5m])",
                    "legendFormat": "{{exporter}}",
                    "refId": "A"
                  }
                ]
              },
              {
                "id": 4,
                "title": "Metrics Exported",
                "type": "timeseries",
                "gridPos": {"x": 12, "y": 8, "w": 12, "h": 8},
                "datasource": {"type": "prometheus", "uid": "Prometheus"},
                "targets": [
                  {
                    "expr": "rate(otelcol_exporter_sent_metric_points[5m])",
                    "legendFormat": "{{exporter}}",
                    "refId": "A"
                  }
                ]
              }
            ]
          }
      backend:
        json: |
          {
            "title": "Backend Application",
            "tags": ["backend", "application"],
            "timezone": "browser",
            "schemaVersion": 38,
            "version": 0,
            "refresh": "10s",
            "time": {
              "from": "now-1h",
              "to": "now"
            },
            "panels": [
              {
                "id": 1,
                "title": "HTTP Requests Total",
                "type": "timeseries",
                "gridPos": {"x": 0, "y": 0, "w": 12, "h": 8},
                "datasource": {"type": "prometheus", "uid": "Prometheus"},
                "targets": [
                  {
                    "expr": "sum(rate(http_requests_total[5m])) by (path, status)",
                    "legendFormat": "{{path}} - {{status}}",
                    "refId": "A"
                  }
                ]
              },
              {
                "id": 2,
                "title": "ConfigMap Reads",
                "type": "timeseries",
                "gridPos": {"x": 12, "y": 0, "w": 12, "h": 8},
                "datasource": {"type": "prometheus", "uid": "Prometheus"},
                "targets": [
                  {
                    "expr": "rate(configmap_read_total[5m])",
                    "legendFormat": "ConfigMap Reads",
                    "refId": "A"
                  }
                ]
              },
              {
                "id": 3,
                "title": "HTTP Requests by Status",
                "type": "piechart",
                "gridPos": {"x": 0, "y": 8, "w": 12, "h": 8},
                "datasource": {"type": "prometheus", "uid": "Prometheus"},
                "targets": [
                  {
                    "expr": "sum(rate(http_requests_total[5m])) by (status)",
                    "legendFormat": "{{status}}",
                    "refId": "A"
                  }
                ]
              },
              {
                "id": 4,
                "title": "HTTP Requests by Path",
                "type": "piechart",
                "gridPos": {"x": 12, "y": 8, "w": 12, "h": 8},
                "datasource": {"type": "prometheus", "uid": "Prometheus"},
                "targets": [
                  {
                    "expr": "sum(rate(http_requests_total[5m])) by (path)",
                    "legendFormat": "{{path}}",
                    "refId": "A"
                  }
                ]
              }
            ]
          }
      tempo:
        gcom:
          - id: 15141
            revision: 0
            datasource: Tempo
          - id: 15139
            revision: 0
            datasource: Tempo
          - id: 15143
            revision: 0
            datasource: Tempo
